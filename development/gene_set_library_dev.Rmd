---
title: "GeneAnnotationParsers"
author: "Joseph"
date: "12/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Parsers
## GO 
What information is needed for a gene set? 

- id
- name
- namespace
- description

...
 linkout
 
```{r GOA Parser}

goa_parser<- function(path_to_goa){
  goa = read_lines(path_to_goa)
  goa = gsub('^!.*$', '', goa)
  goa = goa[!(goa == "")]
  goa = read_tsv(goa, col_names = F, progress = T)
  
  
  colnames(goa) = c("DB","DB OBJECT ID", "DB OBJECT SYMBOL", "QUALIFIER", "GO ID", 
                    "DB:REFERENCE",
                    "EVIDENCE CODE", "WITH OR FROM", "ASPECT", "DB OBJECT NAME",
                    "DB OBJECT SYNONYM", "DB OBJECT TYPE", "TAXON", "DATE", 
                    "ASSIGNED BY", "ANNOTATION EXTENSION", " GENE PRODUCT FORM ID")
  
  goa
}

#P (biological process), F (molecular function) or C (cellular component)

library(EnrichmentBrowser)

goa2gmt <- function(goa, gmt_file = "test.gmt", aspect = "F"){
  
  goa = goa[goa$ASPECT == aspect,]
  goa = goa[,c("DB OBJECT ID", "GO ID")]
  
  sets = goa %>% group_by(`GO ID`) %>% summarise(ITEMS = list(`DB OBJECT ID`))
  sets = setNames(sets$ITEMS, sets$`GO ID`)
  writeGMT(sets, gmt_file)
  
  sets
}

path_to_goa = "/home/joseph/experiments/GeneOntology/goa_human.txt"
goa = goa_parser(path_to_goa)

goa2gmt(goa, "Molecular_Function.gmt", "F")
goa2gmt(goa, "Cellular_Component.gmt", "C")
goa2gmt(goa, "Biological_Process.gmt", "P")


```

```{r OBO Parser}


obo_parser <- function(path_to_obo){
  obo = read_lines(path_to_obo)
  obo
}


obo2termdetails <- function(obo, details_file = "details.tsv"){
  terms = list()
  current_term = NULL
  for (line in obo[1:1000]){
    
    
    if (grepl("^id:", line)){
      current_term = gsub("^id:\\s","",line)
      terms[[current_term]] = list()
      terms[[current_term]] = current_term
    } else if (grepl("^name:", line)){
      terms[[current_term]][["name"]] =  gsub("^name:\\s","",line)
    } else if (grepl("^namespace:", line)){
      terms[[current_term]][["namespace"]] =  gsub("^namespace:\\s","",line)
    } else if (grepl("^def:", line)){
      description = gsub("^def:\\s","",line)
      description = gsub("\"","", description)
      terms[[current_term]][["description"]] = description  
    }
    
  }
  
  terms = data.frame(matrix(unlist(terms), nrow=length(terms), byrow=TRUE),stringsAsFactors=FALSE)
  colnames(terms) = c("id","name","namespace","description")
  terms$linkout = paste("http://amigo.geneontology.org/amigo/term/", terms$id, sep = "")
  
  write_tsv(terms, details_file)
  
  terms
}

obo <- obo_parser(path_to_obo)
terms <- obo2termdetails(obo, "details.tsv")
head(terms)
```

## Reactome


https://reactome.org/download-data
The mapping files consist of a tab-separated table that indicates which external protein, gene or small molecule identifiers in the source database were mapped to Reactome pathway and reaction annotations. Our goal with distributing three sets of files for each different identifier type is to provide these mapping files link the source database identifier to:

the lowest level pathway diagram or subset of the pathway
all level pathway diagrams (filename appended with 'All_Levelsâ€™),
all reaction events.
The columns within the mappings files follow a similar format:

Source database identifier, e.g. UniProt, ENSEMBL, NCBI Gene or ChEBI identifier
 Reactome Pathway Stable identifier
URL
Event (Pathway or Reaction) Name
Evidence Code
Species
If you have any further questions, please contact us.

```{r Reactome}

reactome_parser <- function(path_to_reactome){
  reactome = read_tsv(path_to_reactome,col_names = F)
  colnames(reactome) = c("DB OBJECT ID", "REACTOME ID", "URL", "NAME", "EVIDENCE CODE", "SPECIES")
  reactome
}

reactome2gmt <- function(reactome, gmt_file, species = "Homo sapiens"){
  reactome  = reactome[reactome$SPECIES == species, ]
  reactome = reactome[,c("DB OBJECT ID", "REACTOME ID")]
  sets = reactome %>% group_by(`REACTOME ID`) %>% summarise(ITEMS = list(`DB OBJECT ID`))
  sets = setNames(sets$ITEMS, sets$`REACTOME ID`)
  
  sets[1:10]
  
  writeGMT(sets, gmt_file)
  
  sets
}

path_to_reactome = "/home/joseph/experiments/Reactome/UniProt2Reactome.txt"
reactome = reactome_parser(path_to_reactome)
sets = reactome2gmt(reactome, "Reactome.gmt")
```

```{r}

reactome2termdetails <- function(reactome, details_file_name){
  terms = reactome[,c("REACTOME ID", "URL", "NAME")]
  terms = terms[!duplicated(terms),]
  terms$description = ""
  terms$namespace = "Reactome"
  terms = terms[,c(1,3,5,4,2)]
  colnames(terms) = c("id","name","namespace","description","url")
  terms
}

terms = reactome2termdetails(reactome,"Reactome_details.csv")
```



## UniProt

```{r}

```



## annotation validator:

```{r}

details_validator <- function(details){
  
  # stop if any columns are missing
  required_columns = c("id","name","namespace","description","url")
  for (column in required_columns){
    stopifnot(column %in% colnames(details))
  }
  
  # stop if any ids are missing
  stopifnot(sum(is.na(details$id))==0)
  stopifnot(sum(is.nan(details$id))==0)
  stopifnot(sum(("" == details$id))==0)
  
  print("Term details are valid.")
}

details_validator(terms)
```



# Orchestrator

```{r GO}

# reactome orchestrator
# for lowest level only

go2gmtlibrary <- function(go_dir = "/home/joseph/experiments/GeneOntology",
                          species_files = list.files(go_dir,pattern = ".*.txt$"),
                          details_source =  list.files(go_dir,pattern = ".*.obo$"),
                          destination = "./GeneSetLibraries/GO"){
  
  for (file in species_files){
    path = file.path(go_dir,file)
    species = gsub(".txt","",gsub("goa_","",file))
    mkdirs(file.path(destination,species)) # species dest
    
    print(species)
    print(path)
    goa = goa_parser(path)
    goa2gmt(goa, file.path(destination, species, "Molecular_Function.gmt"), "F")
    goa2gmt(goa, file.path(destination, species, "Cellular_Component.gmt"), "C")
    goa2gmt(goa, file.path(destination, species, "Biological_Process.gmt"), "P")
    print("species done!")
  }
  
  # write term details
  obo <- obo_parser(path_to_obo)
  terms <- obo2termdetails(obo, file.path(destination, "term_details.csv"))
  head(terms)
  
  
  print("done!")
  list.files(path = destination, recursive = TRUE)
}

go2gmtlibrary()
```

```{r Reactome}

#reactome2gmtlibrary


destination = "./GeneSetLibraries/Reactome"
path_to_reactome = "/home/joseph/experiments/Reactome/UniProt2Reactome.txt"
reactome = reactome_parser(path_to_reactome)
all_species = unique(reactome$SPECIES)
print(all_species)

for (species in all_species){
    
    mkdirs(file.path(destination,species)) # species dest
    print(species)
    print(path_to_reactome)
    sets = reactome2gmt(reactome, file.path(destination,species,"Reactome.gmt"), species = species)
    print("species done!")
}

terms = reactome2termdetails(reactome,file.path(destination,"Reactome_details.csv"))
print("done!")
list.files(path = destination, recursive = TRUE)

```


















































